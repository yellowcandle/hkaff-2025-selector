import{u as k,r as E,j as e}from"./index-DMkoEHv9.js";import{f as N,c as D}from"./conflictDetector-BvYDVP-k.js";const L=({screenings:o,venues:u,selectedScreeningIds:b,existingSelections:x=[],onSelectScreening:p})=>{const{i18n:g}=k(),l=g.language==="zh",[c,m]=E.useState(null),a=t=>u.find(s=>s.id===t)||null,f=t=>{const s=new Date(t),n=l?["星期日","星期一","星期二","星期三","星期四","星期五","星期六"][s.getDay()]:N(s,"EEEE");return{date:N(s,"yyyy-MM-dd"),time:N(s,"HH:mm"),dayOfWeek:n}},y=t=>{if(!x.length)return[];const s=a(t.venue_id),n=s?.name_en||"",i=s?.name_tc||"";return D.wouldConflict(x,t,n,i)},h=t=>{const s=t.screening_a.screening_id===c?t.screening_b:t.screening_a;if(t.severity==="impossible"){const n=Math.round(t.overlap_minutes);return l?`與 "${s.film_snapshot.title_tc}" 重疊 ${n} 分鐘`:`Overlaps ${n} minutes with "${s.film_snapshot.title_en}"`}else return l?`與 "${s.film_snapshot.title_tc}" 間隔少於30分鐘，且在不同場地`:`Less than 30 minutes from "${s.film_snapshot.title_en}" at different venue`};return o.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:l?"暫無放映場次":"No screenings available"}):e.jsx("div",{"data-testid":"screenings-list",className:"space-y-3",children:o.map(t=>{const s=a(t.venue_id),{date:n,time:i,dayOfWeek:r}=f(t.datetime),d=b.includes(t.id),j=c===t.id&&!d?y(t):[],_=j.length>0,v=_?j[0].severity:null;return e.jsxs("div",{"data-testid":"screening-item",className:"border rounded-lg transition-colors border-border hover:bg-muted/50",children:[_&&e.jsx("div",{role:"alert","aria-live":"polite",className:`mx-4 mt-4 mb-2 p-3 rounded-md border-l-4 ${v==="impossible"?"bg-red-50 border-red-400":"bg-yellow-50 border-yellow-400"}`,children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("svg",{className:`h-5 w-5 mr-2 flex-shrink-0 ${v==="impossible"?"text-red-400":"text-yellow-400"}`,fill:"currentColor",viewBox:"0 0 20 20","aria-hidden":"true",children:e.jsx("path",{fillRule:"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})}),e.jsxs("div",{children:[e.jsx("p",{className:`text-sm font-medium ${v==="impossible"?"text-red-800":"text-yellow-800"}`,children:l?"選擇此場次將產生衝突：":"Selecting this will create conflicts:"}),j.map((S,C)=>e.jsx("p",{className:`text-xs mt-1 ${v==="impossible"?"text-red-700":"text-yellow-700"}`,children:h(S)},C))]})]})}),e.jsx("div",{className:"p-4 flex flex-col gap-3",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{"data-testid":"screening-datetime",className:"font-semibold text-foreground mb-1",children:[n," (",r,") ",i]}),e.jsx("div",{"data-testid":"screening-venue",className:"text-muted-foreground text-sm",children:s?l?s.name_tc:s.name_en:t.venue_id}),e.jsxs("div",{className:"text-muted-foreground text-sm mt-1",children:[t.duration_minutes," ",l?"分鐘":"minutes"," • ",t.language]})]}),e.jsx("button",{"data-testid":"select-screening-btn",onClick:()=>p(t),onMouseEnter:()=>m(t.id),onMouseLeave:()=>m(null),onFocus:()=>m(t.id),onBlur:()=>m(null),disabled:d,"aria-label":d?l?"已選擇此場次":"Screening already selected":l?"選擇此場次":"Select this screening",className:`min-h-[44px] px-6 py-2 rounded-md font-medium transition-colors whitespace-nowrap ${d?"bg-muted text-muted-foreground cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"}`,children:d?l?"已選擇":"Selected":l?"選擇":"Select"})]})})]},t.id)})})},z=({film:o,category:u,screenings:b,venues:x,selectedScreeningIds:p,existingSelections:g=[],onSelectScreening:l,onClose:c})=>{const{i18n:m}=k(),a=m.language==="tc",f=a?o.title_tc:o.title_en,y=a?o.synopsis_tc:o.synopsis_en,h=u?a?u.name_tc:u.name_en:"";return E.useEffect(()=>{const t=s=>{if(s.key==="Escape"&&c(),s.key==="ArrowDown"||s.key==="ArrowUp"){const n=document.querySelector('[data-testid="film-detail-modal"]');if(!n)return;s.preventDefault();const i=n.querySelectorAll('button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'),r=Array.from(i).indexOf(document.activeElement);if(s.key==="ArrowDown"){const d=(r+1)%i.length;i[d]?.focus()}else{const d=r===0?i.length-1:r-1;i[d]?.focus()}}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[c]),E.useEffect(()=>{const t=document.activeElement;document.body.classList.add("modal-open");const s=document.querySelector('[data-testid="film-detail-modal"]');s&&s.focus();const n=i=>{if(i.key!=="Tab")return;const r=s?.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');if(!r||r.length===0)return;const d=r[0],w=r[r.length-1];i.shiftKey?document.activeElement===d&&(w.focus(),i.preventDefault()):document.activeElement===w&&(d.focus(),i.preventDefault())};return document.addEventListener("keydown",n),()=>{document.body.classList.remove("modal-open"),document.removeEventListener("keydown",n),t&&t.focus()}},[]),e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop",role:"dialog","aria-modal":"true","aria-labelledby":"film-detail-title",children:[e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50",onClick:c,"aria-hidden":"true"}),e.jsxs("div",{"data-testid":"film-detail-modal",tabIndex:-1,className:"relative bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto focus:outline-none",children:[e.jsx("button",{"data-testid":"close-modal-btn",onClick:c,"aria-label":a?"關閉電影詳情":"Close film details",className:"group absolute top-4 right-4 z-10 min-h-[44px] min-w-[44px] p-2 rounded-full bg-gradient-to-br from-destructive/10 to-destructive/5 hover:from-destructive hover:to-primary shadow-lg hover:shadow-xl hover:scale-110 focus:ring-4 focus:ring-destructive/50 focus:ring-offset-2 transition-all duration-300",children:e.jsx("svg",{className:"w-6 h-6 text-destructive group-hover:text-white transition-colors duration-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","aria-hidden":"true",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-6",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("img",{src:o.poster_url,alt:f,loading:"lazy",decoding:"async",className:"w-48 h-72 object-cover rounded-lg shadow-md",onError:t=>{t.currentTarget.src='data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="192" height="288" viewBox="0 0 192 288"%3E%3Crect fill="%23e5e7eb" width="192" height="288"/%3E%3Ctext x="50%25" y="50%25" font-family="Arial" font-size="16" fill="%239ca3af" text-anchor="middle" dominant-baseline="middle"%3ENo Image%3C/text%3E%3C/svg%3E'}})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h2",{id:"film-detail-title",className:"text-2xl md:text-3xl font-bold text-foreground mb-2",children:f}),h&&e.jsx("span",{className:"inline-block px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-md mb-4",children:h}),e.jsxs("div",{className:"space-y-2 text-card-foreground",children:[e.jsxs("div",{"data-testid":"film-director",className:"flex",children:[e.jsxs("span",{className:"font-semibold w-24",children:[a?"導演":"Director",":"]}),e.jsx("span",{children:o.director})]}),e.jsxs("div",{"data-testid":"film-country",className:"flex",children:[e.jsxs("span",{className:"font-semibold w-24",children:[a?"國家":"Country",":"]}),e.jsx("span",{children:o.country})]}),e.jsxs("div",{"data-testid":"film-runtime",className:"flex",children:[e.jsxs("span",{className:"font-semibold w-24",children:[a?"片長":"Runtime",":"]}),e.jsxs("span",{children:[o.runtime_minutes," ",a?"分鐘":"minutes"]})]})]}),e.jsxs("div",{"data-testid":"film-synopsis",className:"mt-4",children:[e.jsx("h3",{className:"font-semibold text-foreground mb-2",children:a?"劇情簡介":"Synopsis"}),e.jsx("p",{className:"text-card-foreground leading-relaxed",children:y})]})]})]})}),e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-xl font-semibold text-foreground mb-4",children:a?"放映場次":"Screenings"}),e.jsx(L,{screenings:b,venues:x,selectedScreeningIds:p,existingSelections:g,onSelectScreening:l})]})]})]})};export{z as FilmDetail};
