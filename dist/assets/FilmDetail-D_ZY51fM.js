import{u as M,r as N,j as e}from"./index-Dwweknxv.js";import{f as j}from"./format-sbWH3_uq.js";const S=30*60*1e3;class D{detectConflicts(i){const a=[];for(let r=0;r<i.length;r++)for(let d=r+1;d<i.length;d++){const m=i[r].screening_snapshot,n=i[d].screening_snapshot,c=new Date(m.datetime).getTime(),u=c+m.duration_minutes*6e4,l=new Date(n.datetime).getTime(),v=l+n.duration_minutes*6e4,b=Math.max(c,l),p=Math.min(u,v),t=Math.max(0,p-b)/6e4;t>0?a.push({screening_a:i[r],screening_b:i[d],overlap_minutes:t,severity:"impossible"}):m.venue_name_en!==n.venue_name_en&&Math.abs(l-u)<S&&a.push({screening_a:i[r],screening_b:i[d],overlap_minutes:0,severity:"warning"})}return a}wouldConflict(i,a){const r={screening_id:a.id,added_at:new Date().toISOString(),film_snapshot:{id:a.film_id,title_tc:"",title_en:"",poster_url:""},screening_snapshot:{id:a.id,datetime:a.datetime,duration_minutes:a.duration_minutes,venue_name_tc:"",venue_name_en:""}},d=[...i,r];return this.detectConflicts(d).filter(n=>n.screening_a.screening_id===a.id||n.screening_b.screening_id===a.id)}calculateOverlap(i,a){const r=new Date(i.datetime).getTime(),d=r+i.duration_minutes*6e4,m=new Date(a.datetime).getTime(),n=m+a.duration_minutes*6e4,c=Math.max(r,m),u=Math.min(d,n);return Math.max(0,u-c)/6e4}hasOverlap(i,a){return this.calculateOverlap(i,a)>0}}const $=new D,L=({screenings:o,venues:i,selectedScreeningIds:a,existingSelections:r=[],onSelectScreening:d})=>{const{i18n:m}=M(),n=m.language==="zh",[c,u]=N.useState(null),l=t=>i.find(s=>s.id===t)||null,v=t=>{const s=new Date(t),x=n?["星期日","星期一","星期二","星期三","星期四","星期五","星期六"][s.getDay()]:j(s,"EEEE");return{date:j(s,"yyyy-MM-dd"),time:j(s,"HH:mm"),dayOfWeek:x}},b=t=>r.length?$.wouldConflict(r,t):[],p=t=>{const s=t.screening_a.screening_id===c?t.screening_b:t.screening_a;if(t.severity==="impossible"){const x=Math.round(t.overlap_minutes);return n?`與 "${s.film_snapshot.title_tc}" 重疊 ${x} 分鐘`:`Overlaps ${x} minutes with "${s.film_snapshot.title_en}"`}else return n?`與 "${s.film_snapshot.title_tc}" 間隔少於30分鐘，且在不同場地`:`Less than 30 minutes from "${s.film_snapshot.title_en}" at different venue`};return o.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:n?"暫無放映場次":"No screenings available"}):e.jsx("div",{"data-testid":"screenings-list",className:"space-y-3",children:o.map(t=>{const s=l(t.venue_id),{date:x,time:g,dayOfWeek:f}=v(t.datetime),h=a.includes(t.id),w=c===t.id&&!h?b(t):[],E=w.length>0,y=E?w[0].severity:null;return e.jsxs("div",{"data-testid":"screening-item",className:"border rounded-lg transition-colors border-gray-200 hover:bg-gray-50",children:[E&&e.jsx("div",{role:"alert","aria-live":"polite",className:`mx-4 mt-4 mb-2 p-3 rounded-md border-l-4 ${y==="impossible"?"bg-red-50 border-red-400":"bg-yellow-50 border-yellow-400"}`,children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("svg",{className:`h-5 w-5 mr-2 flex-shrink-0 ${y==="impossible"?"text-red-400":"text-yellow-400"}`,fill:"currentColor",viewBox:"0 0 20 20","aria-hidden":"true",children:e.jsx("path",{fillRule:"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})}),e.jsxs("div",{children:[e.jsx("p",{className:`text-sm font-medium ${y==="impossible"?"text-red-800":"text-yellow-800"}`,children:n?"選擇此場次將產生衝突：":"Selecting this will create conflicts:"}),w.map((k,C)=>e.jsx("p",{className:`text-xs mt-1 ${y==="impossible"?"text-red-700":"text-yellow-700"}`,children:p(k)},C))]})]})}),e.jsx("div",{className:"p-4 flex flex-col gap-3",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{"data-testid":"screening-datetime",className:"font-semibold text-gray-900 mb-1",children:[x," (",f,") ",g]}),e.jsx("div",{"data-testid":"screening-venue",className:"text-gray-600 text-sm",children:s?n?s.name_tc:s.name_en:t.venue_id}),e.jsxs("div",{className:"text-gray-500 text-sm mt-1",children:[t.duration_minutes," ",n?"分鐘":"minutes"," • ",t.language]})]}),e.jsx("button",{"data-testid":"select-screening-btn",onClick:()=>d(t),onMouseEnter:()=>u(t.id),onMouseLeave:()=>u(null),onFocus:()=>u(t.id),onBlur:()=>u(null),disabled:h,"aria-label":h?n?"已選擇此場次":"Screening already selected":n?"選擇此場次":"Select this screening",className:`min-h-[44px] px-6 py-2 rounded-md font-medium transition-colors whitespace-nowrap ${h?"bg-gray-300 text-gray-600 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"}`,children:h?n?"已選擇":"Selected":n?"選擇":"Select"})]})})]},t.id)})})},O=({film:o,category:i,screenings:a,venues:r,selectedScreeningIds:d,existingSelections:m=[],onSelectScreening:n,onClose:c})=>{const{i18n:u}=M(),l=u.language==="zh",v=l?o.title_tc:o.title_en,b=l?o.synopsis_tc:o.synopsis_en,p=i?l?i.name_tc:i.name_en:"";return N.useEffect(()=>{const t=s=>{s.key==="Escape"&&c()};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[c]),N.useEffect(()=>{const t=document.activeElement;document.body.style.overflow="hidden";const s=document.querySelector('[data-testid="film-detail-modal"]');s&&s.focus();const x=g=>{if(g.key!=="Tab")return;const f=s==null?void 0:s.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');if(!f||f.length===0)return;const h=f[0],_=f[f.length-1];g.shiftKey?document.activeElement===h&&(_.focus(),g.preventDefault()):document.activeElement===_&&(h.focus(),g.preventDefault())};return document.addEventListener("keydown",x),()=>{document.body.style.overflow="unset",document.removeEventListener("keydown",x),t&&t.focus()}},[]),e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",role:"dialog","aria-modal":"true","aria-labelledby":"film-detail-title",children:[e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50",onClick:c,"aria-hidden":"true"}),e.jsxs("div",{"data-testid":"film-detail-modal",tabIndex:-1,className:"relative bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto focus:outline-none",children:[e.jsx("button",{"data-testid":"close-modal-btn",onClick:c,"aria-label":l?"關閉電影詳情":"Close film details",className:"absolute top-4 right-4 z-10 min-h-[44px] min-w-[44px] p-2 rounded-full bg-white shadow-md hover:bg-gray-100 focus:ring-2 focus:ring-blue-500",children:e.jsx("svg",{className:"w-6 h-6 text-gray-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","aria-hidden":"true",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-6",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("img",{src:o.poster_url,alt:v,loading:"lazy",decoding:"async",className:"w-48 h-72 object-cover rounded-lg shadow-md",onError:t=>{t.currentTarget.src='data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="192" height="288" viewBox="0 0 192 288"%3E%3Crect fill="%23e5e7eb" width="192" height="288"/%3E%3Ctext x="50%25" y="50%25" font-family="Arial" font-size="16" fill="%239ca3af" text-anchor="middle" dominant-baseline="middle"%3ENo Image%3C/text%3E%3C/svg%3E'}})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h2",{id:"film-detail-title",className:"text-2xl md:text-3xl font-bold text-gray-900 mb-2",children:v}),p&&e.jsx("span",{className:"inline-block px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-md mb-4",children:p}),e.jsxs("div",{className:"space-y-2 text-gray-700",children:[e.jsxs("div",{"data-testid":"film-director",className:"flex",children:[e.jsxs("span",{className:"font-semibold w-24",children:[l?"導演":"Director",":"]}),e.jsx("span",{children:o.director})]}),e.jsxs("div",{"data-testid":"film-country",className:"flex",children:[e.jsxs("span",{className:"font-semibold w-24",children:[l?"國家":"Country",":"]}),e.jsx("span",{children:o.country})]}),e.jsxs("div",{"data-testid":"film-runtime",className:"flex",children:[e.jsxs("span",{className:"font-semibold w-24",children:[l?"片長":"Runtime",":"]}),e.jsxs("span",{children:[o.runtime_minutes," ",l?"分鐘":"minutes"]})]})]}),e.jsxs("div",{"data-testid":"film-synopsis",className:"mt-4",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-2",children:l?"劇情簡介":"Synopsis"}),e.jsx("p",{className:"text-gray-700 leading-relaxed",children:b})]})]})]})}),e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-4",children:l?"放映場次":"Screenings"}),e.jsx(L,{screenings:a,venues:r,selectedScreeningIds:d,existingSelections:m,onSelectScreening:n})]})]})]})};export{O as FilmDetail};
