import{u as k,r as N,j as e}from"./index-DmkQ_oE6.js";import{f as j}from"./format-Cdttx4Da.js";const S=1800*1e3;class D{detectConflicts(i){const a=[];for(let r=0;r<i.length;r++)for(let o=r+1;o<i.length;o++){const f=i[r].screening_snapshot,n=i[o].screening_snapshot,c=new Date(f.datetime).getTime(),h=c+f.duration_minutes*6e4,l=new Date(n.datetime).getTime(),p=l+n.duration_minutes*6e4,g=Math.max(c,l),b=Math.min(h,p),t=Math.max(0,b-g)/6e4;t>0?a.push({screening_a:i[r],screening_b:i[o],overlap_minutes:t,severity:"impossible"}):f.venue_name_en!==n.venue_name_en&&Math.abs(l-h)<S&&a.push({screening_a:i[r],screening_b:i[o],overlap_minutes:0,severity:"warning"})}return a}wouldConflict(i,a){const r={screening_id:a.id,added_at:new Date().toISOString(),film_snapshot:{id:a.film_id,title_tc:"",title_en:"",poster_url:""},screening_snapshot:{id:a.id,datetime:a.datetime,duration_minutes:a.duration_minutes,venue_name_tc:"",venue_name_en:""}},o=[...i,r];return this.detectConflicts(o).filter(n=>n.screening_a.screening_id===a.id||n.screening_b.screening_id===a.id)}calculateOverlap(i,a){const r=new Date(i.datetime).getTime(),o=r+i.duration_minutes*6e4,f=new Date(a.datetime).getTime(),n=f+a.duration_minutes*6e4,c=Math.max(r,f),h=Math.min(o,n);return Math.max(0,h-c)/6e4}hasOverlap(i,a){return this.calculateOverlap(i,a)>0}}const L=new D,$=({screenings:d,venues:i,selectedScreeningIds:a,existingSelections:r=[],onSelectScreening:o})=>{const{i18n:f}=k(),n=f.language==="zh",[c,h]=N.useState(null),l=t=>i.find(s=>s.id===t)||null,p=t=>{const s=new Date(t),m=n?["星期日","星期一","星期二","星期三","星期四","星期五","星期六"][s.getDay()]:j(s,"EEEE");return{date:j(s,"yyyy-MM-dd"),time:j(s,"HH:mm"),dayOfWeek:m}},g=t=>r.length?L.wouldConflict(r,t):[],b=t=>{const s=t.screening_a.screening_id===c?t.screening_b:t.screening_a;if(t.severity==="impossible"){const m=Math.round(t.overlap_minutes);return n?`與 "${s.film_snapshot.title_tc}" 重疊 ${m} 分鐘`:`Overlaps ${m} minutes with "${s.film_snapshot.title_en}"`}else return n?`與 "${s.film_snapshot.title_tc}" 間隔少於30分鐘，且在不同場地`:`Less than 30 minutes from "${s.film_snapshot.title_en}" at different venue`};return d.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:n?"暫無放映場次":"No screenings available"}):e.jsx("div",{"data-testid":"screenings-list",className:"space-y-3",children:d.map(t=>{const s=l(t.venue_id),{date:m,time:u,dayOfWeek:v}=p(t.datetime),x=a.includes(t.id),w=c===t.id&&!x?g(t):[],E=w.length>0,_=E?w[0].severity:null;return e.jsxs("div",{"data-testid":"screening-item",className:"border rounded-lg transition-colors border-border hover:bg-muted/50",children:[E&&e.jsx("div",{role:"alert","aria-live":"polite",className:`mx-4 mt-4 mb-2 p-3 rounded-md border-l-4 ${_==="impossible"?"bg-red-50 border-red-400":"bg-yellow-50 border-yellow-400"}`,children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("svg",{className:`h-5 w-5 mr-2 flex-shrink-0 ${_==="impossible"?"text-red-400":"text-yellow-400"}`,fill:"currentColor",viewBox:"0 0 20 20","aria-hidden":"true",children:e.jsx("path",{fillRule:"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})}),e.jsxs("div",{children:[e.jsx("p",{className:`text-sm font-medium ${_==="impossible"?"text-red-800":"text-yellow-800"}`,children:n?"選擇此場次將產生衝突：":"Selecting this will create conflicts:"}),w.map((M,C)=>e.jsx("p",{className:`text-xs mt-1 ${_==="impossible"?"text-red-700":"text-yellow-700"}`,children:b(M)},C))]})]})}),e.jsx("div",{className:"p-4 flex flex-col gap-3",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{"data-testid":"screening-datetime",className:"font-semibold text-foreground mb-1",children:[m," (",v,") ",u]}),e.jsx("div",{"data-testid":"screening-venue",className:"text-muted-foreground text-sm",children:s?n?s.name_tc:s.name_en:t.venue_id}),e.jsxs("div",{className:"text-muted-foreground text-sm mt-1",children:[t.duration_minutes," ",n?"分鐘":"minutes"," • ",t.language]})]}),e.jsx("button",{"data-testid":"select-screening-btn",onClick:()=>o(t),onMouseEnter:()=>h(t.id),onMouseLeave:()=>h(null),onFocus:()=>h(t.id),onBlur:()=>h(null),disabled:x,"aria-label":x?n?"已選擇此場次":"Screening already selected":n?"選擇此場次":"Select this screening",className:`min-h-[44px] px-6 py-2 rounded-md font-medium transition-colors whitespace-nowrap ${x?"bg-muted text-muted-foreground cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"}`,children:x?n?"已選擇":"Selected":n?"選擇":"Select"})]})})]},t.id)})})},z=({film:d,category:i,screenings:a,venues:r,selectedScreeningIds:o,existingSelections:f=[],onSelectScreening:n,onClose:c})=>{const{i18n:h}=k(),l=h.language==="tc",p=l?d.title_tc:d.title_en,g=l?d.synopsis_tc:d.synopsis_en,b=i?l?i.name_tc:i.name_en:"";return N.useEffect(()=>{const t=s=>{if(s.key==="Escape"&&c(),s.key==="ArrowDown"||s.key==="ArrowUp"){const m=document.querySelector('[data-testid="film-detail-modal"]');if(!m)return;s.preventDefault();const u=m.querySelectorAll('button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'),v=Array.from(u).indexOf(document.activeElement);if(s.key==="ArrowDown"){const x=(v+1)%u.length;u[x]?.focus()}else{const x=v===0?u.length-1:v-1;u[x]?.focus()}}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[c]),N.useEffect(()=>{const t=document.activeElement;document.body.classList.add("modal-open");const s=document.querySelector('[data-testid="film-detail-modal"]');s&&s.focus();const m=u=>{if(u.key!=="Tab")return;const v=s?.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');if(!v||v.length===0)return;const x=v[0],y=v[v.length-1];u.shiftKey?document.activeElement===x&&(y.focus(),u.preventDefault()):document.activeElement===y&&(x.focus(),u.preventDefault())};return document.addEventListener("keydown",m),()=>{document.body.classList.remove("modal-open"),document.removeEventListener("keydown",m),t&&t.focus()}},[]),e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop",role:"dialog","aria-modal":"true","aria-labelledby":"film-detail-title",children:[e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50",onClick:c,"aria-hidden":"true"}),e.jsxs("div",{"data-testid":"film-detail-modal",tabIndex:-1,className:"relative bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto focus:outline-none",children:[e.jsx("button",{"data-testid":"close-modal-btn",onClick:c,"aria-label":l?"關閉電影詳情":"Close film details",className:"group absolute top-4 right-4 z-10 min-h-[44px] min-w-[44px] p-2 rounded-full bg-gradient-to-br from-destructive/10 to-destructive/5 hover:from-destructive hover:to-primary shadow-lg hover:shadow-xl hover:scale-110 focus:ring-4 focus:ring-destructive/50 focus:ring-offset-2 transition-all duration-300",children:e.jsx("svg",{className:"w-6 h-6 text-destructive group-hover:text-white transition-colors duration-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","aria-hidden":"true",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-6",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("img",{src:d.poster_url,alt:p,loading:"lazy",decoding:"async",className:"w-48 h-72 object-cover rounded-lg shadow-md",onError:t=>{t.currentTarget.src='data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="192" height="288" viewBox="0 0 192 288"%3E%3Crect fill="%23e5e7eb" width="192" height="288"/%3E%3Ctext x="50%25" y="50%25" font-family="Arial" font-size="16" fill="%239ca3af" text-anchor="middle" dominant-baseline="middle"%3ENo Image%3C/text%3E%3C/svg%3E'}})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h2",{id:"film-detail-title",className:"text-2xl md:text-3xl font-bold text-foreground mb-2",children:p}),b&&e.jsx("span",{className:"inline-block px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-md mb-4",children:b}),e.jsxs("div",{className:"space-y-2 text-card-foreground",children:[e.jsxs("div",{"data-testid":"film-director",className:"flex",children:[e.jsxs("span",{className:"font-semibold w-24",children:[l?"導演":"Director",":"]}),e.jsx("span",{children:d.director})]}),e.jsxs("div",{"data-testid":"film-country",className:"flex",children:[e.jsxs("span",{className:"font-semibold w-24",children:[l?"國家":"Country",":"]}),e.jsx("span",{children:d.country})]}),e.jsxs("div",{"data-testid":"film-runtime",className:"flex",children:[e.jsxs("span",{className:"font-semibold w-24",children:[l?"片長":"Runtime",":"]}),e.jsxs("span",{children:[d.runtime_minutes," ",l?"分鐘":"minutes"]})]})]}),e.jsxs("div",{"data-testid":"film-synopsis",className:"mt-4",children:[e.jsx("h3",{className:"font-semibold text-foreground mb-2",children:l?"劇情簡介":"Synopsis"}),e.jsx("p",{className:"text-card-foreground leading-relaxed",children:g})]})]})]})}),e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-xl font-semibold text-foreground mb-4",children:l?"放映場次":"Screenings"}),e.jsx($,{screenings:a,venues:r,selectedScreeningIds:o,existingSelections:f,onSelectScreening:n})]})]})]})};export{z as FilmDetail};
